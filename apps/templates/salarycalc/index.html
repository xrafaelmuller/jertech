<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Calculadora de Salário Líquido</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon2/favicon-96x96.png') }}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/favicon2/favicon.svg') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon2/favicon.ico') }}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/favicon2/apple-touch-icon.png') }}" />
    <meta name="apple-mobile-web-app-title" content="SalaryCalc" />
    <link rel="manifest" href="{{ url_for('static', filename='img/favicon2/site.webmanifest') }}" />

    <link rel="stylesheet" href="{{ url_for('static', filename='style/salary.css') }}">

</head>
<body>
    <div class="container">
        <header>
            <div class="header-top-row">
                <div class="user-info">
                    <span>Olá, <strong>{{ username|capitalize }}</strong>!</span>
                    <a href="{{ url_for('auth.logout') }}">Sair</a>
                </div>
            </div>
            <div class="header-main-row">
                <a href="https://jertech.com.br" class="header-btn" id="back-btn" title="Voltar para J&R Tech">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="22" height="22">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </a>
            
                <h2>Calculadora de Salário Líquido</h2>
            
                <div class="header-page-actions">
                    <div class="action-group" id="profile-action-group">
                        <button class="header-btn" id="profile-btn" title="Gerenciar Perfis">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.042-2.72a3 3 0 00-4.682 2.72a9.094 9.094 0 003.741.479m7.042 2.72a9.094 9.094 0 01-3.741-.479m0 0a9 9 0 01-2.087.09M18 18.72a9 9 0 01-2.087-.09m-7.042 2.72c.622.08.622.08 1.042.162m-1.042-.162a9 9 0 01-2.087-.09M15 11.25a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <div class="side-panel">
                            <h3>Gerenciar Perfis</h3>
                            <div class="profile-load-group" style="margin-bottom: 1.5rem;">
                                <label for="profile_select">Carregar Perfil:</label>
                                <select id="profile_select" onchange="window.location.href='/?load_profile=' + this.value">
                                    <option value="">-- Selecione um Perfil --</option>
                                    {% for profile in profiles %}
                                        <option value="{{ profile }}" {% if profile == profile_data.profile_name %}selected{% endif %}>{{ profile }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="profile-actions">
                                <label for="profile_name">Nome do Perfil para Salvar/Atualizar:</label>
                                <input type="text" id="profile_name" name="profile_name" placeholder="Ex: Meu Salário" value="{{ profile_data.profile_name }}" form="main-calc-form">
                            </div>
                            <div class="button-group">
                                <button type="submit" name="action" value="save_profile" class="secondary" form="main-calc-form" onclick="document.getElementById('form_action').value='save_profile';">Salvar Perfil</button>
                            </div>
                        </div>
                    </div>
            
                    <div class="action-group" id="raise-action-group">
                        <button class="header-btn" id="raise-btn" title="Ajustar Salário">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-3.75-2.25M21 18v-6c0-1.104-.896-2-2-2h-6" /></svg>
                        </button>
                        <div class="side-panel">
                            <h3>Ajustar Salário por Aumento (%)</h3>
                            <div class="input-grid">
                                <div>
                                    <label for="increase_percentage">Percentual de Aumento (%):</label>
                                    <input type="text" id="increase_percentage" name="increase_percentage" placeholder="Ex: 5.5">
                                    <p style="font-size: 0.8rem; color: var(--text-secondary-color); margin-top: 0.5rem;"><small>O aumento será aplicado sobre o <strong>Salário Base atual do formulário</strong>.</small></p>
                                </div>
                            </div>
                            <div class="button-group">
                                <button type="button" id="resetSalario" class="secondary">Resetar Salário Base</button>
                                <button type="button" id="applyIncrease" class="secondary">Aplicar Aumento</button>
                                <button type="button" id="saveIncreasedProfile" class="secondary">Salvar como novo perfil</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flash-messages-js-container">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        </div>
        
        <form method="POST" class="main-form" id="main-calc-form">
            <input type="hidden" name="action" id="form_action" value="calculate">

            <div class="form-section">
                <h4>Rendimentos</h4>
                <div class="input-grid">
                    <div>
                        <label for="salario">Salário Base:</label>
                        <div class="input-group-currency">
                            <input type="text" id="salario" name="salario" value="{{ '%.2f'|format(profile_data.salario)|replace('.', ',') }}" required>
                        </div>
                    </div>
                    <div>
                        <label for="quinquenio">Quinquênio:</label>
                        <div class="input-group-currency">
                            <input type="text" id="quinquenio" name="quinquenio" value="{{ '%.2f'|format(profile_data.quinquenio)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="premiacao">Premiação (se houver):</label>
                        <div class="input-group-currency">
                            <input type="text" id="premiacao" name="premiacao" value="{{ '%.2f'|format(profile_data.premiacao)|replace('.', ',') }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>Descontos</h4>
                <div class="input-grid">
                    <div>
                        <label for="vale_alimentacao">Vale Alimentação:</label>
                        <div class="input-group-currency">
                            <input type="text" id="vale_alimentacao" name="vale_alimentacao" value="{{ '%.2f'|format(profile_data.vale_alimentacao)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="plano_saude">Plano de Saúde:</label>
                        <div class="input-group-currency">
                            <input type="text" id="plano_saude" name="plano_saude" value="{{ '%.2f'|format(profile_data.plano_saude)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="previdencia_privada">Previdência (seu contracheque):</label>
                        <div class="input-group-split">
                            <select id="previdencia_percentual_selector">
                                <option value="">% do salário </option>
                                    {% for i in range(1, 9) %}
                                        <option value="{{ i * 0.5 }}">{{ i * 0.5 }}%</option>
                                    {% endfor %}
                            </select>
                            <div class="input-group-currency">
                                <input type="text" id="previdencia_privada" name="previdencia_privada" value="{{ '%.2f'|format(profile_data.previdencia_privada)|replace('.', ',') }}">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="odontologico">Odontológico:</label>
                        <div class="input-group-currency">
                            <input type="text" id="odontologico" name="odontologico" value="{{ '%.2f'|format(profile_data.odontologico)|replace('.', ',') }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <input type="submit" value="Calcular" onclick="document.getElementById('form_action').value='calculate';">
            </div>
        </form>
        
        {% if salario_liquido is not none %}
        <div class="result">
            <p>Seu Salário Líquido Estimado: <strong>R$ {{ "%.2f"|format(salario_liquido)|replace('.', ',') }}</strong></p>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            document.querySelectorAll('.action-group').forEach(group => {
                let hideTimeout;
                const button = group.querySelector('.header-btn');
                const panel = group.querySelector('.side-panel');

                if (!button || !panel) return;

                const showPanel = () => {
                    clearTimeout(hideTimeout);
                    document.querySelectorAll('.action-group').forEach(otherGroup => {
                        if (otherGroup !== group) {
                            otherGroup.classList.remove('active');
                        }
                    });
                    group.classList.add('active');
                };

                const hidePanel = () => {
                    hideTimeout = setTimeout(() => {
                        group.classList.remove('active');
                    }, 200);
                };

                button.addEventListener('mouseenter', showPanel);
                button.addEventListener('focus', showPanel);
                group.addEventListener('mouseleave', hidePanel);

            });


            function flashMessage(message, category = 'info') {
                let flashContainer = document.querySelector('.flash-messages-js-container');
                if (!flashContainer) { return; }
                
                const existingJsMessages = flashContainer.querySelectorAll('.js-flash');
                existingJsMessages.forEach(msg => msg.remove());

                const msgDiv = document.createElement('div');
                msgDiv.className = `flash-message ${category} js-flash`;
                msgDiv.textContent = message;
                msgDiv.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                flashContainer.prepend(msgDiv);
                
                setTimeout(() => {
                    msgDiv.style.opacity = '1';
                    msgDiv.style.transform = 'translateY(0)';
                }, 10);


                setTimeout(() => {
                    msgDiv.style.opacity = '0';
                    msgDiv.style.transform = 'translateY(-20px)';
                    msgDiv.addEventListener('transitionend', () => msgDiv.remove());
                }, 5000);
            }

            const applyIncreaseButton = document.getElementById('applyIncrease');
            const saveIncreasedProfileButton = document.getElementById('saveIncreasedProfile');
            const increasePercentageInput = document.getElementById('increase_percentage');
            const salarioBaseInput = document.getElementById('salario');
            const profileNameInput = document.getElementById('profile_name'); 
            const resetSalarioButton = document.getElementById('resetSalario');
            
            let originalSalarioBase = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
            
            if (applyIncreaseButton) {
                applyIncreaseButton.addEventListener('click', function() {
                    let currentSalario = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                    let increasePercentage = parseFloat(increasePercentageInput.value.replace(',', '.')) || 0;

                    if (isNaN(increasePercentage) || increasePercentage < 0) {
                        flashMessage('Por favor, insira um percentual de aumento válido e não negativo.', 'danger'); return;
                    }

                    let newSalario = currentSalario * (1 + (increasePercentage / 100));
                    salarioBaseInput.value = newSalario.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    flashMessage(`Salário Base atualizado para R$ ${salarioBaseInput.value}.`, 'success');
                });
            }
            
            if (resetSalarioButton) {
                resetSalarioButton.addEventListener('click', function() {
                    salarioBaseInput.value = originalSalarioBase.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    increasePercentageInput.value = '';
                    flashMessage('Salário Base restaurado para o valor original.', 'info');
                });
            }

            if (saveIncreasedProfileButton) {
                saveIncreasedProfileButton.addEventListener('click', function() {
                    const newProfileName = prompt("Digite um nome para o novo perfil com o salário ajustado:");
                    if (newProfileName && newProfileName.trim() !== "") {
                        profileNameInput.value = newProfileName.trim();
                        document.getElementById('form_action').value = 'save_profile'; 
                        document.getElementById('main-calc-form').submit();
                    } else if (newProfileName !== null) {
                        flashMessage("O nome do perfil não pode ser vazio.", 'danger');
                    }
                });
            }

            const previdenciaSelector = document.getElementById('previdencia_percentual_selector');
            const previdenciaInput = document.getElementById('previdencia_privada');

            if (previdenciaSelector && salarioBaseInput && previdenciaInput) {
                previdenciaSelector.addEventListener('change', function () {
                    const percentual = parseFloat(this.value);
                    const salario = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                    
                    if (!isNaN(percentual) && !isNaN(salario) && this.value) {
                        const valor = salario * (percentual / 100);
                        previdenciaInput.value = valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        flashMessage(`Valor de previdência atualizado para ${previdenciaInput.value}.`, 'info');
                    }
                });
            }
        });
    </script>
</body>
</html>