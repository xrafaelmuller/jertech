<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Calculadora de Sal√°rio L√≠quido</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon2/favicon-96x96.png') }}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/favicon2/favicon.svg') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon2/favicon.ico') }}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/favicon2/apple-touch-icon.png') }}" />
    <meta name="apple-mobile-web-app-title" content="SalaryCalc" />
    <link rel="manifest" href="{{ url_for('static', filename='img/favicon2/site.webmanifest') }}" />

    <!-- Link para seu arquivo CSS externo -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style/salarycalc/main.css') }}">

</head>
<body>
    <div class="container">
        <header>
            <h2>Calculadora de Sal√°rio L√≠quido</h2>
            <div class="user-info">
                Ol√°, <strong>{{ username|capitalize }}</strong>!
                <a href="{{ url_for('logout') }}">Sair</a>
            </div>
        </header>

        <div class="flash-messages-js-container">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        </div>
        
        <form method="POST" class="main-form" id="main-calc-form">
            <input type="hidden" name="action" id="form_action" value="calculate">

            <div class="form-section">
                <h4>Rendimentos</h4>
                <div class="input-grid">
                    <div>
                        <label for="salario">Sal√°rio Base:</label>
                        <div class="input-group-currency">
                            <input type="text" id="salario" name="salario" value="{{ '%.2f'|format(profile_data.salario)|replace('.', ',') }}" required>
                        </div>
                    </div>
                    <div>
                        <label for="quinquenio">Quinqu√™nio:</label>
                        <div class="input-group-currency">
                            <input type="text" id="quinquenio" name="quinquenio" value="{{ '%.2f'|format(profile_data.quinquenio)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="premiacao">Premia√ß√£o (se houver):</label>
                        <div class="input-group-currency">
                            <input type="text" id="premiacao" name="premiacao" value="{{ '%.2f'|format(profile_data.premiacao)|replace('.', ',') }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>Descontos</h4>
                <div class="input-grid">
                    <div>
                        <label for="vale_alimentacao">Vale Alimenta√ß√£o:</label>
                        <div class="input-group-currency">
                            <input type="text" id="vale_alimentacao" name="vale_alimentacao" value="{{ '%.2f'|format(profile_data.vale_alimentacao)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="plano_saude">Plano de Sa√∫de:</label>
                        <div class="input-group-currency">
                            <input type="text" id="plano_saude" name="plano_saude" value="{{ '%.2f'|format(profile_data.plano_saude)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="previdencia_privada">Previd√™ncia (seu contracheque):</label>
                        <div class="input-group-split">
                            <select id="previdencia_percentual_selector">
                                <option value="">% do sal√°rio </option>
                                    {% for i in range(1, 9) %}
                                        <option value="{{ i * 0.5 }}">{{ i * 0.5 }}%</option>
                                    {% endfor %}
                            </select>
                            <div class="input-group-currency">
                                <input type="text" id="previdencia_privada" name="previdencia_privada" value="{{ '%.2f'|format(profile_data.previdencia_privada)|replace('.', ',') }}">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="odontologico">Odontol√≥gico:</label>
                        <div class="input-group-currency">
                            <input type="text" id="odontologico" name="odontologico" value="{{ '%.2f'|format(profile_data.odontologico)|replace('.', ',') }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <input type="submit" value="Calcular" onclick="document.getElementById('form_action').value='calculate';">
            </div>
        </form>
        
        {% if salario_liquido is not none %}
        <div class="result">
            <p>Seu Sal√°rio L√≠quido Estimado: <strong>R$ {{ "%.2f"|format(salario_liquido)|replace('.', ',') }}</strong></p>
        </div>
        {% endif %}
    </div>

    <!-- --- NOVOS ELEMENTOS FLUTUANTES --- -->
    <div class="floating-actions">
        <div class="floating-action-group" id="profile-action-group">
            <button class="floating-btn" id="profile-btn" title="Gerenciar Perfis">üë•</button>
            <div class="side-panel" id="profile-panel">
                <h3>Gerenciar Perfis</h3>
                <div class="profile-load-group" style="margin-bottom: 1.5rem;">
                    <label for="profile_select">Carregar Perfil:</label>
                    <select id="profile_select" onchange="window.location.href='/?load_profile=' + this.value">
                        <option value="">-- Selecione um Perfil --</option>
                        {% for profile in profiles %}
                            <option value="{{ profile }}" {% if profile == profile_data.profile_name %}selected{% endif %}>{{ profile }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="profile-actions">
                    <label for="profile_name">Nome do Perfil para Salvar/Atualizar:</label>
                    <input type="text" id="profile_name" name="profile_name" placeholder="Ex: Meu Sal√°rio" value="{{ profile_data.profile_name }}" form="main-calc-form">
                </div>
                <div class="button-group">
                    <button type="submit" name="action" value="save_profile" class="secondary" form="main-calc-form" onclick="document.getElementById('form_action').value='save_profile';">Salvar Perfil</button>
                </div>
            </div>
        </div>

        <a href="https://jertech.com.br" class="floating-btn" id="back-btn" title="Voltar para J&R Tech">‚Üê</a>

        <div class="floating-action-group" id="raise-action-group">
            <button class="floating-btn" id="raise-btn" title="Ajustar Sal√°rio">üìà</button>
            <div class="side-panel" id="raise-panel">
                <h3>Ajustar Sal√°rio por Aumento (%)</h3>
                <div class="input-grid">
                    <div>
                        <label for="increase_percentage">Percentual de Aumento (%):</label>
                        <input type="text" id="increase_percentage" name="increase_percentage" placeholder="Ex: 5.5">
                        <p style="font-size: 0.8rem; color: var(--text-secondary-color); margin-top: 0.5rem;"><small>O aumento ser√° aplicado sobre o <strong>Sal√°rio Base atual do formul√°rio</strong>.</small></p>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" id="resetSalario" class="secondary">Resetar Sal√°rio Base</button>
                    <button type="button" id="applyIncrease" class="secondary">Aplicar Aumento</button>
                    <button type="button" id="saveIncreasedProfile" class="secondary">Salvar como novo perfil</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- NOVA L√ìGICA PARA A√á√ïES FLUTUANTES ---
            document.querySelectorAll('.floating-action-group').forEach(group => {
                let hideTimeout;

                group.addEventListener('mouseenter', () => {
                    clearTimeout(hideTimeout);
                    // Fecha outros pain√©is antes de abrir um novo
                    document.querySelectorAll('.floating-action-group').forEach(otherGroup => {
                        if (otherGroup !== group) {
                            otherGroup.classList.remove('active');
                        }
                    });
                    group.classList.add('active');
                });

                group.addEventListener('mouseleave', () => {
                    hideTimeout = setTimeout(() => {
                        group.classList.remove('active');
                    }, 300); // Um pequeno delay para permitir mover o cursor para dentro do painel
                });
            });


            function flashMessage(message, category = 'info') {
                let flashContainer = document.querySelector('.flash-messages-js-container');
                if (!flashContainer) { return; }
                
                const existingJsMessages = flashContainer.querySelectorAll('.js-flash');
                existingJsMessages.forEach(msg => msg.remove());

                const msgDiv = document.createElement('div');
                msgDiv.className = `flash-message ${category} js-flash`;
                msgDiv.textContent = message;
                msgDiv.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                flashContainer.prepend(msgDiv);
                
                setTimeout(() => {
                    msgDiv.style.opacity = '1';
                    msgDiv.style.transform = 'translateY(0)';
                }, 10);


                setTimeout(() => {
                    msgDiv.style.opacity = '0';
                    msgDiv.style.transform = 'translateY(-20px)';
                    msgDiv.addEventListener('transitionend', () => msgDiv.remove());
                }, 5000);
            }

            const applyIncreaseButton = document.getElementById('applyIncrease');
            const saveIncreasedProfileButton = document.getElementById('saveIncreasedProfile');
            const increasePercentageInput = document.getElementById('increase_percentage');
            const salarioBaseInput = document.getElementById('salario');
            const profileNameInput = document.getElementById('profile_name'); 
            const resetSalarioButton = document.getElementById('resetSalario');
            
            let originalSalarioBase = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
            
            if (applyIncreaseButton) {
                applyIncreaseButton.addEventListener('click', function() {
                    let currentSalario = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                    let increasePercentage = parseFloat(increasePercentageInput.value.replace(',', '.')) || 0;

                    if (isNaN(increasePercentage) || increasePercentage < 0) {
                        flashMessage('Por favor, insira um percentual de aumento v√°lido e n√£o negativo.', 'danger'); return;
                    }

                    let newSalario = currentSalario * (1 + (increasePercentage / 100));
                    salarioBaseInput.value = newSalario.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    flashMessage(`Sal√°rio Base atualizado para R$ ${salarioBaseInput.value}.`, 'success');
                });
            }
            
            if (resetSalarioButton) {
                resetSalarioButton.addEventListener('click', function() {
                    salarioBaseInput.value = originalSalarioBase.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    increasePercentageInput.value = '';
                    flashMessage('Sal√°rio Base restaurado para o valor original.', 'info');
                });
            }

            if (saveIncreasedProfileButton) {
                saveIncreasedProfileButton.addEventListener('click', function() {
                    const newProfileName = prompt("Digite um nome para o novo perfil com o sal√°rio ajustado:");
                    if (newProfileName && newProfileName.trim() !== "") {
                        profileNameInput.value = newProfileName.trim();
                        document.getElementById('form_action').value = 'save_profile'; 
                        document.getElementById('main-calc-form').submit();
                    } else if (newProfileName !== null) {
                        flashMessage("O nome do perfil n√£o pode ser vazio.", 'danger');
                    }
                });
            }

            const previdenciaSelector = document.getElementById('previdencia_percentual_selector');
            const previdenciaInput = document.getElementById('previdencia_privada');

            if (previdenciaSelector && salarioBaseInput && previdenciaInput) {
                previdenciaSelector.addEventListener('change', function () {
                    const percentual = parseFloat(this.value);
                    const salario = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                    
                    if (!isNaN(percentual) && !isNaN(salario) && this.value) {
                        const valor = salario * (percentual / 100);
                        previdenciaInput.value = valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        flashMessage(`Valor de previd√™ncia atualizado para ${previdenciaInput.value}.`, 'info');
                    }
                });
            }
        });
    </script>
</body>
</html>
